import {
  CodeSurfer,
  CodeSurferColumns,
  Step
} from "code-surfer";
import { github, vsDark } from "@code-surfer/themes";
import "prismjs/components/prism-docker.js"

import ImageWithLabel from './components/ImageWithLabel'
import YoutubeVideo from './components/YoutubeVideo'

import ToUpperCase from './components/ToUpperCase'

import dockerLogo from './static/docker-logo.png'
import containerVsVm from './static/containers-vs-virtual-machines.jpg'
import dockerWikiBasics from './static/docker-wiki-basics.png'
import dockerLinuxInterfaces from './static/docker-linux-interfaces.png'

export const theme = vsDark;

<!--  1 Container vs VM -->
<!--  2 Why Docker? History, Pro vs Cons, Alternatives -->
<!--  3 Install Docker -->
<!--  4 Build a Docker Container -->
<!--  4 Run a Docker Container -->
<!--  5 Link two Docker Container -->
<!--  6 Build a Docker Image (Architectures, base images, builder pattern) -->
<!--  6 What is Docker-compose -->
<!--  6 What is Docker-swarm -->
<!--  6 What is Kubernetes -->
<!--  6 Questions -->
<!--  6 Thank you -->
<!--  6 Link to repo -->

# Docker 101

<ImageWithLabel style={{backgroundColor: "#FFFFFF"}} label="Author: Marcel Rösler">
    <img src={dockerLogo} />
</ImageWithLabel>

https://github.com/BelphegorPrime/mdx-decker

---

<ImageWithLabel label="Container VS Virtual Maschine">
    <img src={containerVsVm} />
</ImageWithLabel>

---

## Additional Resources Container vs VM

[docker-containers-vs-vms](https://www.weave.works/blog/a-practical-guide-to-choosing-between-docker-containers-and-vms)

---

<ImageWithLabel>
    <img src={dockerWikiBasics} />
</ImageWithLabel>

---

<ImageWithLabel label="Docker kann verschiedene Schnittstellen verwenden, um auf Virtualisierungsfunktionen des Linux-Kernels zuzugreifen.">
    <img src={dockerLinuxInterfaces} />
</ImageWithLabel>

---

## Additional Resources to Docker

[https://de.wikipedia.org/wiki/Docker_(Software)](https://de.wikipedia.org/wiki/Docker_(Software))

---

## Install Docker

There are multiple ways but a good way is to follow the installation guide in the official documentation

https://docs.docker.com/engine/install/debian/

---

## Begriffe

- Dockerfile

    eine Textdatei, die mit verschiedenen Befehlen ein Image beschreibt. Diese werden bei der Ausführung abgearbeitet und für jeden Befehl wird ein einzelner Layer angelegt.

- Layer

    ein Layer ist Teil eines Images und enthält einen Befehl oder eine Datei, die dem Image hinzugefügt wurde. Anhand der Layer kann die ganze Historie des Images nachvollzogen werden.

---

## Einschub - Storage Driver

- overlay2
- fuse-overlayfs
- btrfs and zfs
- vfs
- aufs
- devicemapper
- overlay

https://docs.docker.com/storage/storagedriver/select-storage-driver/

---

## Begriffe 2

- Image

    ein Speicherabbild eines Containers. Das Image selbst besteht aus mehreren Layern, die schreibgeschützt sind und somit nicht verändert werden können. Ein Image ist portabel, kann in Repositories gespeichert und mit anderen Nutzern geteilt werden. Aus einem Image können immer mehrere Container gestartet werden.

- Repository

    ein Repository ist ein Satz gleichnamiger Images mit verschiedenen Tags, zumeist Versionen.

---

## Begriffe 3

- Registry

    eine Registry, wie zum Beispiel Docker Hub oder Artifactory, dient der Verwaltung von Repositories.

- Container

    als Container wird die aktive Instanz eines Images bezeichnet. Der Container wird also gerade ausgeführt und ist beschäftigt. Sobald der Container kein Programm ausführt oder mit seinem Auftrag fertig ist, wird der Container automatisch beendet.

---

<CodeSurfer>

```json title="Vorwort Beispiel"
[
  {
    "domain": "omv.local.net",
    "portMap": [
      {
        "from": 80,
        "to": 9999
      }
    ]
  },
  {
    "domain": "router.local.net",
    "portMap": [
      {
        "from": 80,
        "ip": "192.168.0.1",
        "to": 80
      }
    ]
  },
  ...
]
```

</CodeSurfer>

---

<CodeSurfer>

```docker title="Dockerfile und die Layer"
FROM node:12

WORKDIR /app

COPY ./balancer.json .
COPY ./balancer.js .

ENV ip=192.168.0.111

RUN node balancer.js

```

```docker 1
FROM node:lts

WORKDIR /app

COPY ./balancer.json .
COPY ./balancer.js .

ENV ip=192.168.0.111

RUN node balancer.js

```

```docker 7,8,9,10,11
FROM node:lts

WORKDIR /app

COPY ./balancer.json .
COPY ./balancer.js .
COPY ./.env .

RUN npm init -y
RUN npm i dotenv

RUN node balancer.js

```

```docker 5,6
FROM node:lts

WORKDIR /app

RUN npm init -y
RUN npm i dotenv

COPY ./balancer.json .
COPY ./balancer.js .
COPY ./.env .

RUN node balancer.js

```

```docker 1
FROM node:lts AS builder

WORKDIR /app

RUN npm init -y
RUN npm i dotenv

COPY ./balancer.json .
COPY ./balancer.js .
COPY ./.env .

RUN node balancer.js

```

```docker 14,15
FROM node:lts AS builder

WORKDIR /app

RUN npm init -y
RUN npm i dotenv

COPY ./balancer.json .
COPY ./balancer.js .
COPY ./.env .

RUN node balancer.js

FROM haproxy:2.3
COPY --from=builder /app/haproxy.cfg /usr/local/etc/haproxy/haproxy.cfg

```

</CodeSurfer>

---

## A regular slide

---

<CodeSurfer>

```yml title="A DOCKER-COMPOSE FILE"
version: '3.7'

services:
  app:
    image: thecodingmachine/php:7.4-v3-apache
    ports:
      - ${APP_PORT:-8000}:80
    volumes:
      - ./:/var/www/html
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      messenger:
        condition: service_started
    environment:
      PHP_EXTENSION_XDEBUG: 1
      PHP_EXTENSION_GD: 1

      APACHE_DOCUMENT_ROOT: public/

      STARTUP_COMMAND: composer install

      PHP_IDE_CONFIG: "serverName=localhost"
      PHP_INI_MEMORY_LIMIT: 1g
      PHP_INI_DATE__TIMEZONE: Europe/Berlin
      PHP_INI_UPLOAD_MAX_FILESIZE: 150M
      PHP_INI_POST_MAX_SIZE: 200M
    healthcheck:
      test: [ "CMD", "curl", "-s", "-f", "-i", "http://localhost" ]
      interval: 20s
      timeout: 60s
      start_period: 15s

  es-indexer:
    image: thecodingmachine/php:7.4-v3-apache
    volumes:
      - ./:/var/www/html
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      PHP_EXTENSION_XDEBUG: 1
      PHP_EXTENSION_GD: 1

      APACHE_DOCUMENT_ROOT: public/

      STARTUP_COMMAND: bin/console fos:elastica:create || bin/console fos:elastica:populate

      PHP_IDE_CONFIG: "serverName=localhost"
      PHP_INI_MEMORY_LIMIT: 1g
      PHP_INI_DATE__TIMEZONE: Europe/Berlin
    healthcheck:
      test: [ "CMD", "curl", "-s", "-f", "-i", "http://localhost" ]
      interval: 20s
      timeout: 60s
      start_period: 15s

  messenger:
    image: thecodingmachine/php:7.4-v3-apache
    volumes:
      - ./:/var/www/html
    command: php bin/console messenger:consume async -vv
    environment:
      PHP_INI_DATE__TIMEZONE: Europe/Berlin

  encore:
    image: thecodingmachine/nodejs:14
    working_dir: /app
    volumes:
      - ./:/app
    environment:
      REACT_APP_MERCURE_URL: http://localhost:9090/.well-known/mercure

      STARTUP_COMMAND_1: npm install
    command: npm run watch
    depends_on:
      app:
        condition: service_started

  elasticsearch:
    image: elasticsearch:2.0.0
    environment:
      - cluster.name=auction
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: curl -u elastic:elastic -s -f localhost:9200/_cat/health >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5

  # https://mercure.rocks/docs/hub/install
  mercure:
    image: dunglas/mercure:v0.12
    environment:
      MERCURE_PUBLISHER_JWT_KEY: '!ChangeMe!'
      MERCURE_SUBSCRIBER_JWT_KEY: '!ChangeMe!'
      ALLOW_ANONYMOUS: 1
      CORS_ALLOWED_ORIGINS: '*'
      PUBLISH_ALLOWED_ORIGINS: 'http://localhost'
      SERVER_NAME: ':80'
    ports:
      - ${MERCURE_PORT:-9090}:80
    command: caddy run -config /etc/caddy/Caddyfile.dev

  db:
    image: mysql:5.7
    command: mysqld --sql_mode=""
    volumes:
      - ./dump:/docker-entrypoint-initdb.d
      - mysql:/var/lib/mysql
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: 'true'
      MYSQL_DATABASE: auction_catalog
      MYSQL_USER: auction_catalog
      MYSQL_PASSWORD: auction_catalog
    healthcheck:
      test: mysqladmin status
      interval: 10s
      start_period: 2s
      timeout: 10s
      retries: 10
    ports:
      - 33306:3306

  redis:
    image: redis:5-alpine
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 1s
      timeout: 3s
      retries: 30

  db_testing:
    image: mariadb:10.4
    tmpfs: /var/lib/mysql
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: 'true'
      MYSQL_DATABASE: auction_catalog
      MYSQL_USER: auction_catalog
      MYSQL_PASSWORD: auction_catalog
    healthcheck:
      test: mysqladmin status
      interval: 20s
      start_period: 2s
      timeout: 10s
      retries: 3


  data-processor:
    image: git.hw.ag:5050/fischer/auction-catalog-dataprocessor/live-bidding
    volumes:
      - ./docker/data-processor.properties:/app/app.properties
      - ./storage:/app/storage

  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - 8025:8025
volumes:
  mysql:
    driver: local
```

```diff 1[10:14] subtitle="docker-compose version"

```

```diff 3[1:14] subtitle="services"

```

```diff 4:36

```

</CodeSurfer>

---

<CodeSurfer>

```js
console.log(1);
console.log(2);
console.log(3);
```

```diff 1 subtitle="log 1"

```

```diff 2 subtitle="log 2"

```

```diff 3 subtitle="log 3"

```

</CodeSurfer>

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js
const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);
```

</Step>

<Step>

```js
const lorem = (ipsum, dolor, sit) => {
  const amet = dolor - ipsum;
  return consectetur.adipiscing(
    {
      elit: sed.eiusmod(sit - dolor) / amet + 2,
    },
    (tempor, incididunt) => ipsum + amet * incididunt
  );
};

const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);

const sed = (eiusmod, tempor, incididunt) => {
  const ut = tempor - eiusmod;
  return labore.et(
    {
      amet: dolore.magna(incididunt - tempor) / ut + 2,
    },
    (aliqua, elit) => eiusmod + ut * elit
  );
};
```

</Step>

</CodeSurferColumns>

---

<YoutubeVideo src="https://www.youtube-nocookie.com/embed/D2gXo-T4wqA" />

---

## Questions

---

Thank you for your participation.

